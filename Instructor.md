# SBP Analyzer (層級行為分析器 (Ad-hoc 分析版)) - 開發指引

## 目標

SBP Analyzer 專注於**離線深度學習模型分析Ad-hoc**，旨在提供全面的工具來分析模型結構、訓練動態以及中間層的行為模式，主要目標包括：

1. **模型結構和參數分析**：解析模型架構、參數分佈和複雜度，識別可能的優化機會
2. **訓練動態分析**：評估訓練過程中的損失曲線、指標變化和學習率影響
3. **中間層激活值分析**：檢測層級異常（如死亡神經元、飽和現象）和激活模式
4. **報告生成**：生成結構化、可視化的分析報告，提供可操作的見解

## 工作流程

1. 從保存的實驗結果目錄讀取數據（模型結構、訓練歷史、中間層激活值等）
2. 分析模型結構和參數統計特性
3. 分析訓練過程中的損失函數和指標變化
4. 分析中間層的激活值分佈和統計特性
5. 生成視覺化結果（圖表、熱圖等）
6. 輸出結構化的分析報告（HTML 或 Markdown 格式）

## 主要挑戰

1. **適應不同模型架構**：處理各種深度學習模型（CNN、Transformer、GNN等）
2. **異常檢測標準**：定義和檢測層級行為異常（例如何時判定為死亡神經元）
3. **報告內容和格式**：決定哪些指標和視覺化結果最有幫助
4. **性能和擴展性**：處理大型模型和大量數據
5. **提供可操作的見解**：不僅識別問題，還提供改進建議

## 開發路線圖

### 階段一：基礎設施和數據載入（已完成）

- [X]  建立項目基礎架構和目錄結構
- [X]  實現 ExperimentLoader 用於讀取實驗配置和結果
- [X]  實現 HookDataLoader 用於讀取中間層激活值
- [X]  設計基礎的 Analyzer 接口和類

### 階段二：模型結構分析（已完成）

- [X]  實現 ModelStructureAnalyzer 進行模型參數分析
- [X]  添加參數分佈統計和視覺化
- [X]  添加模型複雜度計算（FLOPs、參數數量）
- [X]  提供模型結構摘要和圖表

### 階段三：訓練動態分析（已完成）

- [X]  實現 TrainingDynamicsAnalyzer 解析訓練歷史
- [X]  添加損失曲線分析和視覺化
- [X]  添加學習率影響分析
- [X]  添加過擬合/欠擬合檢測

### 階段四：中間層數據分析（已完成）

- [X]  實現 IntermediateDataAnalyzer 分析中間層激活值
- [X]  添加層級統計指標（均值、標準差、分位數）
- [X]  實現死亡/飽和神經元檢測
- [X]  添加層級相似度和激活模式變化分析
- [X]  實現有效秩計算和特徵重要性分析

### 階段五：報告生成和整合（已完成）

- [X]  實現 ReportGenerator 生成結構化報告
- [X]  設計報告模板支持 HTML 和 Markdown 格式
- [X]  整合所有分析結果到報告中
- [X]  添加可配置的報告生成選項
- [X]  實現 generate_report 方法以支持測試需求

### 階段六：整合和測試（進行中）

- [X]  實現 SBPAnalyzer 統一接口整合所有功能
- [X]  編寫單元測試覆蓋關鍵功能
- [X]  添加集成測試確保所有組件協同工作
- [X]  修復測試過程中發現的 API 不一致問題
- [X]  改善錯誤處理和健壯性

### 階段七：完善和優化（計劃中）

- [ ]  處理test的import issue
- [ ]  優化性能和資源使用
- [ ]  改進異常檢測標準和閾值設定
- [ ]  添加更多層級行為指標
- [ ]  精細化報告內容和建議系統
- [ ]  擴展支持的模型類型

## 技術考量

### 1. 數據結構

#### 實驗數據結構

- `experiment_dir/`
  - `config.json`: 實驗配置
  - `model_structure.json`: 模型結構信息
  - `training_history.json`: 訓練歷史記錄
  - `models/`: 模型權重
  - `hooks/`: 中間層數據
    - `epoch_N/`: 各輪次數據
      - `layer_activations.pt`: 激活值張量

#### 分析結果結構

- `analysis_results/`
  - `model_structure/`: 模型結構分析結果
  - `training_dynamics/`: 訓練動態分析結果
  - `intermediate_data/`: 中間層數據分析結果
    - `layer_results`: 層級統計和異常信息
    - `cross_layer_analysis`: 層間關係分析

### 2. 層級活動指標設計

- **基本統計**：均值、標準差、最大/最小值、分位數
- **稀疏度指標**：零值比例、L1/L2正則化指標
- **活動模式**：激活分佈形狀、峰度、偏度
- **死亡/飽和檢測**：零活動率、飽和率（達到最大值的比例）
- **有效秩分析**：通過 SVD 計算層的有效維度
- **相似度分析**：層間和批次間的相似度計算

### 3. 報告結構設計

- **概述部分**：模型整體情況和主要發現
- **模型結構部分**：架構摘要和參數統計
- **訓練動態部分**：損失曲線和收斂性分析
- **層級分析部分**：各層統計和異常情況
- **問題診斷部分**：潛在問題和建議解決方案
- **可視化附錄**：詳細圖表和分佈

## 測試策略

### 單元測試

- 為每個核心功能編寫單元測試
- 使用 mock 數據測試分析器的各個方法
- 驗證計算結果和統計指標的正確性

### 集成測試

- 測試完整的分析流程，從數據載入到報告生成
- 使用真實世界的模型和數據進行端到端測試
- 驗證各組件之間的交互正確性

### 性能測試

- 測試大型模型和大量數據的處理能力
- 測量內存使用情況和處理時間
- 識別性能瓶頸並優化

## 最近修復和改進

- [X]  修復 `IntermediateDataAnalyzer` 返回結構不一致問題，統一使用 `layer_results` 而非 `layer_statistics`
- [X]  實現 `ReportGenerator.generate_report` 方法，支持特定測試需求的臨時參數覆蓋
- [X]  修正 `visualization/__init__.py` 中的模塊名稱錯誤 (ModelStructurePlots -> ModelStructurePlotter)
- [X]  修復 `calculate_effective_rank` 函數處理特殊形狀張量的問題
- [X]  將 `run_complete_tests.py` 移至 `legacy` 目錄，支持直接使用 pytest 命令運行測試
- [X]  修復 `distribution_metrics.py` 中的形狀處理和維度轉換問題
- [X]  增強 `HookDataLoader` 的異常處理能力，尤其是處理舊版格式數據時
- [X]  改進測試用例以適應最新的 API 結構

## 重構和改進方向

### API 一致性

- 統一所有分析器的返回格式和結構
- 標準化方法命名和參數規範
- 確保接口設計的一致性和可預測性

### 錯誤處理

- 增強錯誤檢測和報告
- 添加更明確的錯誤訊息和故障排除建議
- 實現處理不完整或損壞數據的機制

### 文檔

- 完善所有類和方法的 docstring
- 添加更多使用示例和教程
- 更新 README 和 API 文檔

### 性能優化

- 優化張量操作和計算
- 實現增量處理大型數據集的機制
- 添加進度報告和中斷/恢復功能

### 擴展性

- 設計插件機制支持新的分析器和指標
- 使模型架構支持更加模組化
- 提供自定義報告和可視化的接口

## 開發環境和工具

- Python 3.8+
- PyTorch 2.0+
- 主要依賴：numpy, pandas, matplotlib, seaborn
- 開發工具：pytest, black, flake8, mypy
